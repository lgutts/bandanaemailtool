<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate SendGrid-ready HTML emails from Bandana.com job listings. Paste URLs, auto-extract job data, copy email HTML.">
  <meta name="theme-color" content="#FCE776">
  <meta property="og:title" content="Bandana Email Builder">
  <meta property="og:description" content="Generate SendGrid-ready HTML emails from Bandana.com job listings.">
  <meta property="og:type" content="website">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%23FCE776'/><text x='50' y='72' font-size='60' text-anchor='middle' font-family='sans-serif' font-weight='bold'>B</text></svg>">
  <title>Bandana Email Builder</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">

  <style>
    /* ===== Reset & Variables ===== */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --surface-2: #222222;
      --border: #2a2a2a;
      --border-focus: #FCE776;
      --text: #e8e8e8;
      --text-dim: #888888;
      --accent: #FCE776;
      --accent-hover: #fdd835;
      --danger: #ff6b6b;
      --success: #4ecdc4;
      --radius: 8px;
      --radius-lg: 12px;
    }

    /* ===== Base ===== */
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* ===== Header ===== */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #000;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .header h1 span {
      color: var(--accent);
    }

    /* ===== Layout ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
      display: grid;
      grid-template-columns: 1fr 500px;
      gap: 32px;
    }

    .input-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .preview-panel {
      position: sticky;
      top: 90px;
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ===== Instructions ===== */
    .instructions {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .instructions h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
    }

    .instructions ol {
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .instructions li {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .instructions code {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--accent);
    }

    /* ===== Labels ===== */
    .section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .field-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* ===== Inputs ===== */
    input, select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-family: inherit;
      font-size: 13px;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s, background 0.2s;
      width: 100%;
    }

    input:focus, select:focus {
      border-color: var(--accent);
    }

    input::placeholder {
      color: #555;
    }

    input.autofilled {
      border-color: rgba(78, 205, 196, 0.4);
      background: rgba(78, 205, 196, 0.05);
    }

    /* ===== Job Cards ===== */
    .job-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: border-color 0.2s;
    }

    .job-card:focus-within {
      border-color: var(--border-focus);
    }

    .job-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .job-number {
      font-size: 12px;
      font-weight: 700;
      background: var(--accent);
      color: #000;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .url-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .url-row input {
      flex: 1;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .detail-grid .full-width {
      grid-column: 1 / -1;
    }

    /* ===== Status Badges ===== */
    .job-status {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--surface-2);
      color: var(--text-dim);
      transition: all 0.2s;
    }

    .job-status.loaded   { background: rgba(78, 205, 196, 0.15); color: var(--success); }
    .job-status.error    { background: rgba(255, 107, 107, 0.15); color: var(--danger); }
    .job-status.fetching { background: rgba(252, 231, 118, 0.15); color: var(--accent); }
    .job-status.verified { background: rgba(78, 205, 196, 0.25); color: var(--success); }

    /* ===== ID Verification ===== */
    .id-verify {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 11px;
      font-weight: 500;
      display: none;
    }

    .id-verify.match {
      display: block;
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
      color: var(--success);
    }

    .id-verify.mismatch {
      display: block;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--danger);
    }

    /* ===== Logo Preview ===== */
    .logo-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding: 10px;
      background: var(--bg);
      border-radius: var(--radius);
    }

    .logo-preview img {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      background: #f0f0f0;
    }

    .logo-preview span {
      font-size: 12px;
      color: var(--text-dim);
      word-break: break-all;
    }

    /* ===== Schema Raw ===== */
    .schema-raw {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-dim);
      background: var(--bg);
      padding: 8px;
      border-radius: 6px;
      max-height: 100px;
      overflow-y: auto;
      display: none;
      font-family: 'SF Mono', 'Fira Code', monospace;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .schema-raw.visible {
      display: block;
    }

    .toggle-raw {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 11px;
      cursor: pointer;
      padding: 4px 0;
      text-decoration: underline;
      margin-top: 4px;
      font-family: inherit;
    }

    /* ===== Buttons ===== */
    .btn-fetch {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius);
      padding: 10px 16px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s;
    }

    .btn-fetch:hover  { background: var(--accent-hover); }
    .btn-fetch:disabled { opacity: 0.4; cursor: not-allowed; }

    .clear-btn {
      background: none;
      border: none;
      color: var(--danger);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.15s;
      font-family: inherit;
    }

    .clear-btn:hover {
      background: rgba(255, 107, 107, 0.1);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn-generate {
      flex: 1;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 10px;
      padding: 14px 24px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: -0.2px;
    }

    .btn-generate:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-copy {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 20px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-copy:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ===== Preview ===== */
    .preview-frame {
      background: #ffffff;
      border-radius: var(--radius-lg);
      overflow: hidden;
      max-height: 600px;
      overflow-y: auto;
    }

    .preview-frame::-webkit-scrollbar       { width: 6px; }
    .preview-frame::-webkit-scrollbar-thumb  { background: #ccc; border-radius: 3px; }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--success);
      color: #000;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* ===== Responsive ===== */
    @media (max-width: 1100px) {
      .container {
        grid-template-columns: 1fr;
      }

      .preview-panel {
        position: static;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 16px;
      }

      .header {
        padding: 16px;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }

      .detail-grid .full-width {
        grid-column: 1;
      }
    }
  </style>
</head>

<body>
  <!-- ===== Header ===== -->
  <header class="header">
    <div class="header-left">
      <div class="header-logo" aria-hidden="true">B</div>
      <h1>Bandana <span>Email Builder</span></h1>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="container">

    <!-- Left: Input Panel -->
    <section class="input-panel">

      <div class="instructions">
        <h3>How to use</h3>
        <ol>
          <li>Paste a <code>bandana.com/jobs/...</code> URL → click <strong>Fetch</strong></li>
          <li>Reads the <code>&lt;script type="application/ld+json"&gt;</code> <strong>JobPosting</strong> schema from the page</li>
          <li>Extracts <strong>title, company, salary, location</strong> and <strong>verifies the job ID</strong> matches your URL</li>
          <li>Logo auto-loads from <code>logo.dev</code> — edit domain to fix</li>
          <li><strong>Generate Email</strong> → <strong>Copy HTML</strong> → paste into SendGrid code block</li>
        </ol>
      </div>

      <div style="margin-bottom: 12px;">
        <div class="field-group">
          <label class="field-label" for="greeting">Greeting Text</label>
          <input type="text" id="greeting" value="Here are today's jobs recommended for you:" placeholder="e.g. Here are today's remote jobs...">
        </div>
      </div>

      <div id="job-cards" role="list"></div>
    </section>

    <!-- Right: Preview Panel -->
    <aside class="preview-panel">
      <div class="section-label">Email Preview</div>
      <div class="preview-frame" id="preview-frame">
        <div style="padding: 40px 20px; text-align: center; color: #aaa; font-size: 14px;">
          Fill in jobs and click "Generate Email"
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn-generate" id="btn-generate">Generate Email</button>
        <button class="btn-copy" id="btn-copy">Copy HTML</button>
      </div>
    </aside>

  </main>

  <!-- Toast notification -->
  <div class="toast" id="toast" role="alert" aria-live="polite"></div>

  <!-- ===== Application Logic ===== -->
  <script>
    (() => {
      'use strict';

      /* ---------- Constants ---------- */
      const LOGO_TOKEN = 'live_6a1a28fd-6420-4492-aeb0-b297461d9de2';
      const NUM_JOBS   = 5;

      const PROXIES = [
        url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
      ];

      const KNOWN_DOMAINS = {
        'mta': 'mta.info',
        'metropolitan transportation authority': 'mta.info',
        'cvs': 'cvs.com',
        'cvs health': 'cvs.com',
        'walmart': 'walmart.com',
        'amazon': 'amazon.com',
        'target': 'target.com',
        'costco': 'costco.com',
        'ups': 'ups.com',
        'fedex': 'fedex.com',
        'usps': 'usps.com',
        'home depot': 'homedepot.com',
        'the home depot': 'homedepot.com',
        'lowes': 'lowes.com',
        "lowe's": 'lowes.com',
        'starbucks': 'starbucks.com',
        'mcdonalds': 'mcdonalds.com',
        "mcdonald's": 'mcdonalds.com',
        'chipotle': 'chipotle.com',
        'patreon': 'patreon.com',
        'dropbox': 'dropbox.com',
        'ramp': 'ramp.com',
        'squire': 'getsquire.com',
        'earnest': 'earnest.com',
        'nyc health + hospitals': 'nychealthandhospitals.org',
        'city of new york': 'nyc.gov',
        'nypd': 'nyc.gov',
        'dsny': 'nyc.gov',
        'included health': 'includedhealth.com',
        'enterprise mobility': 'enterpriseholdings.com',
        'jpmorgan chase': 'jpmorganchase.com',
        'bank of america': 'bankofamerica.com',
        'wells fargo': 'wellsfargo.com',
        'google': 'google.com',
        'meta': 'meta.com',
        'apple': 'apple.com',
        'microsoft': 'microsoft.com',
        'netflix': 'netflix.com',
      };

      let generatedHTML = '';

      /* ---------- Helpers ---------- */

      const $ = id => document.getElementById(id);

      function logoUrl(domain) {
        return `https://img.logo.dev/${domain || 'bandana.com'}?token=${LOGO_TOKEN}&size=128&retina=false&format=png&theme=dark`;
      }

      function extractJobId(url) {
        const m = url.match(/\/jobs\/([a-f0-9-]{36})/i);
        return m ? m[1] : null;
      }

      function guessDomain(company) {
        const key = company.toLowerCase().trim();
        return KNOWN_DOMAINS[key] || key.replace(/[^a-z0-9]/g, '') + '.com';
      }

      function extractDomain(org) {
        if (!org) return '';
        for (const key of ['sameAs', 'url']) {
          if (org[key]) {
            try {
              return new URL(org[key].startsWith('http') ? org[key] : `https://${org[key]}`).hostname.replace(/^www\./, '');
            } catch (e) { /* skip */ }
          }
        }
        return '';
      }

      /* ---------- Schema Parsing ---------- */

      function extractJobPostingSchemas(html) {
        const schemas = [];
        const re = /<script[^>]*type\s*=\s*["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi;
        let m;
        while ((m = re.exec(html)) !== null) {
          try {
            const data = JSON.parse(m[1].trim());
            const items = Array.isArray(data) ? data : [data];
            for (const item of items) {
              if (item['@type'] === 'JobPosting') schemas.push(item);
              if (item['@graph']) {
                item['@graph'].forEach(g => {
                  if (g['@type'] === 'JobPosting') schemas.push(g);
                });
              }
            }
          } catch (e) { /* skip invalid JSON */ }
        }
        return schemas;
      }

      function formatSalary(baseSalary) {
        if (!baseSalary) return '';
        const v = baseSalary.value;
        if (!v) return '';

        let amount = '';
        let unit = '';

        if (typeof v === 'object') {
          const ut = (v.unitText || '').toUpperCase();
          unit = { HOUR: '/hr', YEAR: '/yr', MONTH: '/mo' }[ut] || '';

          if (v.minValue != null && v.maxValue != null) {
            amount = `$${Number(v.minValue).toFixed(2)} - $${Number(v.maxValue).toFixed(2)}`;
          } else if (v.value != null) {
            amount = `$${Number(v.value).toFixed(2)}`;
          } else if (v.minValue != null) {
            amount = `$${Number(v.minValue).toFixed(2)}+`;
          }
        } else if (typeof v === 'number') {
          amount = `$${v.toFixed(2)}`;
        }

        return amount ? `${amount}${unit}` : '';
      }

      function formatLocation(jobLocation) {
        if (!jobLocation) return '';
        const loc = Array.isArray(jobLocation) ? jobLocation[0] : jobLocation;
        if (!loc) return '';

        const addr = loc.address;
        if (!addr) return loc.name || '';
        if (typeof addr === 'string') return addr;

        return [addr.streetAddress, addr.addressLocality, addr.addressRegion]
          .filter(Boolean)
          .join(', ');
      }

      /* ---------- Proxy Fetch ---------- */

      async function fetchWithProxy(url) {
        for (const proxyFn of PROXIES) {
          try {
            const resp = await fetch(proxyFn(url), { signal: AbortSignal.timeout(12000) });
            if (resp.ok) {
              const text = await resp.text();
              if (text.length > 500) return text;
            }
          } catch (e) { continue; }
        }
        throw new Error('All proxies failed');
      }

      /* ---------- UI Helpers ---------- */

      function setField(n, field, value) {
        const el = $(`${field}-${n}`);
        el.value = value;
        el.classList.add('autofilled');
        setTimeout(() => el.classList.remove('autofilled'), 3000);
      }

      function setStatus(n, text, cls) {
        const el = $(`status-${n}`);
        el.textContent = text;
        el.className = 'job-status' + (cls ? ` ${cls}` : '');
      }

      function updateLogoPreview(n) {
        const domain = $(`domain-${n}`).value.trim();
        if (domain) {
          $(`logo-img-${n}`).src = logoUrl(domain);
          $(`logo-url-${n}`).textContent = domain;
          $(`domain-${n}`).dataset.manual = 'true';
        }
      }

      function autoGuessDomain(n) {
        const company = $(`company-${n}`).value.trim();
        const domainEl = $(`domain-${n}`);
        if (company && !domainEl.dataset.manual) {
          domainEl.value = guessDomain(company);
          updateLogoPreview(n);
        }
      }

      function showToast(msg) {
        const toast = $('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
      }

      /* ---------- Clear ---------- */

      function clearJob(n) {
        ['url', 'title', 'company', 'domain', 'salary', 'location'].forEach(f => {
          const el = $(`${f}-${n}`);
          el.value = '';
          el.classList.remove('autofilled');
        });
        $(`logo-img-${n}`).src = logoUrl('bandana.com');
        $(`logo-url-${n}`).textContent = 'Set company domain';
        $(`id-verify-${n}`).style.display = 'none';
        $(`schema-raw-${n}`).textContent = '';
        $(`schema-raw-${n}`).classList.remove('visible');
        delete $(`domain-${n}`).dataset.manual;
        setStatus(n, 'Empty', '');
      }

      /* ---------- Fetch Job ---------- */

      async function fetchJob(n) {
        const urlInput = $(`url-${n}`).value.trim();
        if (!urlInput || !urlInput.includes('bandana.com/jobs/')) {
          setStatus(n, 'Invalid URL', 'error');
          return;
        }

        const urlJobId = extractJobId(urlInput);
        if (!urlJobId) {
          setStatus(n, 'No job ID in URL', 'error');
          return;
        }

        const btn = $(`fetch-btn-${n}`);
        btn.disabled = true;
        btn.textContent = '...';
        setStatus(n, 'Fetching...', 'fetching');

        const verifyEl = $(`id-verify-${n}`);
        verifyEl.className = 'id-verify';
        verifyEl.style.display = 'none';

        try {
          const html = await fetchWithProxy(urlInput);
          const schemas = extractJobPostingSchemas(html);
          const rawEl = $(`schema-raw-${n}`);
          rawEl.textContent = schemas.length
            ? JSON.stringify(schemas[0], null, 2)
            : 'No JobPosting schema found in page HTML';

          if (!schemas.length) {
            // Fallback: parse <title> tag
            const tm = html.match(/<title[^>]*>(.*?)<\/title>/i);
            if (tm) {
              const parts = tm[1].replace(/&amp;/g, '&').replace(/&#39;/g, "'").split(' - ');
              if (parts.length >= 2) {
                setField(n, 'company', parts[0].replace(/\s*Jobs?\s*$/i, '').trim());
                setField(n, 'title', (parts[1] || '').trim());
                if (parts.length > 2) setField(n, 'location', parts.slice(2).join(', ').trim());
                $(`domain-${n}`).value = guessDomain(parts[0].replace(/\s*Jobs?\s*$/i, '').trim());
                updateLogoPreview(n);
              }
            }
            setStatus(n, 'No schema — title fallback', 'loaded');
            btn.disabled = false;
            btn.textContent = 'Fetch';
            return;
          }

          const schema = schemas[0];

          // --- ID Verification ---
          let schemaId = '';
          if (schema.identifier) {
            schemaId = typeof schema.identifier === 'string'
              ? schema.identifier
              : (schema.identifier.value || '');
          }
          if (!schemaId) schemaId = schema['@id'] || schema.url || '';

          const schemaIdStr = String(schemaId);
          const schemaUrl = schema.url || schema['@id'] || '';
          let idVerified = false;

          if (schemaIdStr.includes(urlJobId) || schemaUrl.includes(urlJobId)) {
            idVerified = true;
            verifyEl.className = 'id-verify match';
            verifyEl.innerHTML = `✅ <strong>ID Verified</strong> — Schema matches URL: <code style="font-size:10px;background:rgba(78,205,196,0.15);padding:2px 6px;border-radius:3px;">${urlJobId}</code>`;
          } else if (schemaIdStr || schemaUrl) {
            verifyEl.className = 'id-verify mismatch';
            verifyEl.innerHTML = `⚠️ <strong>Check ID</strong> — URL: <code style="font-size:10px">${urlJobId}</code> vs Schema: <code style="font-size:10px">${schemaIdStr || schemaUrl}</code>`;
          } else {
            idVerified = true;
            verifyEl.className = 'id-verify match';
            verifyEl.innerHTML = `✅ <strong>Data loaded</strong> from correct URL (no schema ID to cross-check)`;
          }
          verifyEl.style.display = 'block';

          // --- Extract & Fill Fields ---
          const title    = schema.title || schema.name || '';
          const org      = schema.hiringOrganization || {};
          const company  = org.name || '';
          const salary   = formatSalary(schema.baseSalary);
          const location = formatLocation(schema.jobLocation);
          const domain   = extractDomain(org) || guessDomain(company);

          if (title)   setField(n, 'title', title);
          if (company) setField(n, 'company', company);
          if (salary)  setField(n, 'salary', salary);
          if (location) setField(n, 'location', location);
          if (domain) {
            $(`domain-${n}`).value = domain;
            $(`domain-${n}`).classList.add('autofilled');
            updateLogoPreview(n);
          }

          setStatus(n,
            idVerified ? 'Verified ✓' : 'Loaded (check ID)',
            idVerified ? 'verified' : 'loaded'
          );

        } catch (err) {
          console.error('Fetch error:', err);
          setStatus(n, 'Fetch failed — fill manually', 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Fetch';
      }

      /* ---------- Email Generation ---------- */

      function hasJobAfter(idx) {
        for (let j = idx + 1; j <= NUM_JOBS; j++) {
          if ($(`title-${j}`).value.trim() || $(`company-${j}`).value.trim()) return true;
        }
        return false;
      }

      function generateEmail() {
        const greeting = $('greeting').value || "Here are today's jobs recommended for you:";
        let jobsHTML = '';
        let count = 0;

        for (let i = 1; i <= NUM_JOBS; i++) {
          const title    = $(`title-${i}`).value.trim();
          const company  = $(`company-${i}`).value.trim();
          const domain   = $(`domain-${i}`).value.trim();
          const salary   = $(`salary-${i}`).value.trim();
          const location = $(`location-${i}`).value.trim();
          const url      = $(`url-${i}`).value.trim() || 'https://bandana.com/search';

          if (!title && !company) continue;
          count++;

          const logo    = logoUrl(domain || 'bandana.com');
          const compLoc = [company, location].filter(Boolean).join(' \u00B7 ');
          const divider = hasJobAfter(i)
            ? '\n              <table role="presentation" cellpadding="0" cellspacing="0" width="100%"><tr><td style="border-bottom: 1px solid #f0ede6;"></td></tr></table>'
            : '';
          const pad = count === 1 ? 'padding-bottom: 0;' : 'padding-top: 16px;';

          jobsHTML += `
          <tr>
            <td style="${pad}">
              <table role="presentation" cellpadding="0" cellspacing="0" width="100%" class="job-row">
                <tr>
                  <td colspan="2" style="padding-bottom: 8px;">
                    <a href="${url}" target="_blank" class="job-title" style="font-size: 15px; font-weight: 700; color: #191919; text-decoration: none;">${title || 'Job Title'}</a>
                  </td>
                </tr>
                <tr>
                  <td style="vertical-align: middle; padding-bottom: 20px;">
                    <table role="presentation" cellpadding="0" cellspacing="0">
                      <tr>
                        <td style="vertical-align: middle; padding-right: 10px;">
                          <img src="${logo}" alt="" width="36" height="36" style="display: block; border-radius: 8px; background: #f0f0f0;" />
                        </td>
                        <td style="vertical-align: middle;">
                          <p style="margin: 0; font-size: 13px; color: #525252; line-height: 1.3;">${compLoc || 'Company'}</p>
                          <p style="margin: 2px 0 0 0; font-size: 13px; font-weight: 600; color: #191919;">${salary || 'View Pay'}</p>
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td align="right" style="vertical-align: middle; padding-bottom: 20px;">
                    <a href="${url}" target="_blank" class="btn-details" style="display: inline-block; padding: 8px 18px; border: 1.5px solid #d4d0c8; border-radius: 8px; font-size: 13px; font-weight: 600; color: #191919; text-decoration: none; background: #ffffff;">View Details</a>
                  </td>
                </tr>
              </table>${divider}
            </td>
          </tr>`;
        }

        if (!count) {
          alert('Fill in at least one job.');
          return;
        }

        const preheader = ' &#847;'.repeat(150);

        generatedHTML = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs for You</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body, table, td, p, a { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .job-title { color: #191919; text-decoration: none; }
    .job-title:hover { text-decoration: underline; }
    .btn-details { display: inline-block; padding: 8px 18px; border: 1.5px solid #d4d0c8; border-radius: 8px; font-size: 13px; font-weight: 600; color: #191919; text-decoration: none; background: #ffffff; }
    .btn-details:hover { background: #f7f3ec; }
    @media only screen and (max-width: 600px) {
      .outer-pad { padding: 24px 16px !important; }
      .job-row td { padding-left: 0 !important; padding-right: 0 !important; }
    }
  </style>
</head>
<body style="margin: 0; padding: 0; width: 100%; background-color: #ffffff; font-size: 15px; line-height: 1.5; color: #191919; -webkit-font-smoothing: antialiased;">
  <div style="display: none; max-height: 0px; overflow: hidden; mso-hide: all;">${preheader}
  </div>
  <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background-color: #ffffff;">
    <tr>
      <td align="center" class="outer-pad" style="padding: 40px 24px 32px;">
        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="max-width: 480px;">
          <tr>
            <td align="center" style="padding-bottom: 32px;">
              <img src="http://cdn.mcauto-images-production.sendgrid.net/b8e738f0a339492e/d4b5b65d-4eed-48ed-aff8-521902cd4284/128x128.png" alt="Bandana" width="40" height="40" style="display: block;" />
            </td>
          </tr>
          <tr>
            <td style="padding-bottom: 4px;">
              <p style="margin: 0; font-size: 15px; color: #191919;">Hi {{first_name default="there"}},</p>
            </td>
          </tr>
          <tr>
            <td style="padding-bottom: 28px;">
              <p style="margin: 0; font-size: 15px; color: #525252;">${greeting}</p>
            </td>
          </tr>
${jobsHTML}
          <tr>
            <td align="center" style="padding: 32px 0 40px;">
              <table role="presentation" cellpadding="0" cellspacing="0">
                <tr>
                  <td style="border-radius: 999px; background-color: #FCE776;">
                    <a href="https://bandana.com/search" target="_blank" style="display: inline-block; padding: 14px 32px; font-size: 15px; font-weight: 700; color: #191919; text-decoration: none;">See More Jobs</a>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td align="center" style="padding: 24px 0 0 0; border-top: 1px solid #f0f0f0;">
              <p style="margin: 0; font-size: 13px; color: #a3a3a3;">You're receiving this because of your job preferences on Bandana.</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`;

        $('preview-frame').innerHTML =
          `<iframe srcdoc="${generatedHTML.replace(/"/g, '&quot;')}" style="width:100%;height:600px;border:none;"></iframe>`;
      }

      /* ---------- Copy ---------- */

      function copyHTML() {
        if (!generatedHTML) generateEmail();
        if (!generatedHTML) return;

        navigator.clipboard.writeText(generatedHTML)
          .then(() => showToast('HTML copied to clipboard!'))
          .catch(() => {
            const ta = document.createElement('textarea');
            ta.value = generatedHTML;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('Copied!');
          });
      }

      /* ---------- Build Job Cards ---------- */

      function buildJobCards() {
        const container = $('job-cards');

        for (let n = 1; n <= NUM_JOBS; n++) {
          container.insertAdjacentHTML('beforeend', `
            <div class="job-card" id="card-${n}" role="listitem">
              <div class="job-card-header">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="job-number">${n}</div>
                  <span style="font-size:14px;font-weight:600;">Job ${n}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span class="job-status" id="status-${n}">Empty</span>
                  <button class="clear-btn" data-clear="${n}">Clear</button>
                </div>
              </div>

              <div class="url-row">
                <input type="text" id="url-${n}" placeholder="https://bandana.com/jobs/..." data-fetch="${n}">
                <button class="btn-fetch" id="fetch-btn-${n}" data-fetchbtn="${n}">Fetch</button>
              </div>

              <div class="id-verify" id="id-verify-${n}"></div>

              <div class="detail-grid">
                <div class="field-group full-width">
                  <label class="field-label" for="title-${n}">Job Title</label>
                  <input type="text" id="title-${n}" placeholder="e.g. Administrative Assistant">
                </div>
                <div class="field-group">
                  <label class="field-label" for="company-${n}">Company Name</label>
                  <input type="text" id="company-${n}" placeholder="e.g. MTA" data-company="${n}">
                </div>
                <div class="field-group">
                  <label class="field-label" for="domain-${n}">Company Domain (for logo)</label>
                  <input type="text" id="domain-${n}" placeholder="e.g. mta.info" data-domain="${n}">
                </div>
                <div class="field-group">
                  <label class="field-label" for="salary-${n}">Salary / Pay</label>
                  <input type="text" id="salary-${n}" placeholder="e.g. $25.76 - $38.70/hr">
                </div>
                <div class="field-group">
                  <label class="field-label" for="location-${n}">Location</label>
                  <input type="text" id="location-${n}" placeholder="e.g. 2 Broadway, Financial District">
                </div>
              </div>

              <div class="logo-preview">
                <img id="logo-img-${n}" src="${logoUrl('bandana.com')}" alt="Company logo">
                <span id="logo-url-${n}">Set company domain to load logo</span>
              </div>

              <button class="toggle-raw" data-toggle="${n}">Show raw schema</button>
              <div class="schema-raw" id="schema-raw-${n}"></div>
            </div>
          `);
        }
      }

      /* ---------- Event Delegation ---------- */

      function bindEvents() {
        // Delegated click events
        document.addEventListener('click', e => {
          const clearBtn = e.target.closest('[data-clear]');
          if (clearBtn) return clearJob(+clearBtn.dataset.clear);

          const fetchBtn = e.target.closest('[data-fetchbtn]');
          if (fetchBtn) return fetchJob(+fetchBtn.dataset.fetchbtn);

          const toggleBtn = e.target.closest('[data-toggle]');
          if (toggleBtn) {
            $(`schema-raw-${toggleBtn.dataset.toggle}`).classList.toggle('visible');
            return;
          }
        });

        // Delegated input events
        document.addEventListener('input', e => {
          const companyInput = e.target.closest('[data-company]');
          if (companyInput) return autoGuessDomain(+companyInput.dataset.company);

          const domainInput = e.target.closest('[data-domain]');
          if (domainInput) return updateLogoPreview(+domainInput.dataset.domain);
        });

        // Enter key on URL inputs
        document.addEventListener('keydown', e => {
          const urlInput = e.target.closest('[data-fetch]');
          if (urlInput && e.key === 'Enter') return fetchJob(+urlInput.dataset.fetch);
        });

        // Action buttons
        $('btn-generate').addEventListener('click', generateEmail);
        $('btn-copy').addEventListener('click', copyHTML);
      }

      /* ---------- Init ---------- */

      function init() {
        buildJobCards();
        bindEvents();
      }

      // Boot
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
